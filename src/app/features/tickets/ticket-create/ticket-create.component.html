<mcs-page [header]="'ticketCreate.header' | translate">
  <!-- Top Panel -->
  <mcs-top-panel *mcsTopPanelDef>
    <!-- Server Creation -->
    <mcs-top-panel-item *mcsTopPanelItemDef no-border>
      <mcs-action-item mcsAlign="end" mcsId
        mcsRouterLink="Tickets"
        mcsEventTracker="navigate-to-ticket-listing"
        mcsEventCategory="ticket"
        mcsEventLabel="create-new-ticket-page">
        <mcs-icon [key]="backIconKey" size="small"></mcs-icon>
        <span>{{ 'ticketCreate.backToTickets' | translate }}</span>
      </mcs-action-item>
    </mcs-top-panel-item>
  </mcs-top-panel>

  <!-- Content Panel -->
  <mcs-content-panel *mcsContentPanelDef>
    <p [innerHTML]="('ticketCreate.description' | translate) | mcsNewLines "></p>
    <div class="contextual-help-page-wrapper limited-view">
      <form [formGroup]="fgCreateTicket" mcsFormGroup>
        <!-- Ticket Type -->
        <mcs-form-field>
          <mcs-select mcsId="select-type" required
            [placeholder]="'ticketCreate.placeholders.type' | translate"
            [formControl]="fcType"
            [mcsContextualHelp]="'ticketCreate.contextualHelp.type' | translate">

            <mcs-option-group>
              <ng-container *mcsOptionGroupHeader>
                {{ 'ticketCreate.typeHeader' | translate }}
              </ng-container>
              <mcs-option *ngFor="let ticketType of ticketTypeList"
                [value]="ticketType.value">
                {{ ticketType.text }}
              </mcs-option>
            </mcs-option-group>
          </mcs-select>

          <mcs-error mcsError errorState="required">
            {{ 'ticketCreate.errors.typeRequired' | translate }}
          </mcs-error>
        </mcs-form-field>

        <!-- Reference -->
        <mcs-form-field>
          <input mcsInput mcsSetFocus #referenceInput
            mcsId="input-reference"
            [placeholder]="'ticketCreate.placeholders.reference' | translate" maxlength="15"
            [formControl]="fcReference"
            [mcsContextualHelp]="'ticketCreate.contextualHelp.reference' | translate">

          <mcs-hint mcsHint align="start">
            {{ convertMaxCharText('ticketCreate.hints.reference' | translate, referenceInput.maxLength) }}
          </mcs-hint>
          <mcs-hint mcsHint align="end">
            {{ referenceInput.value.length }} / {{ referenceInput.maxLength }}
          </mcs-hint>
        </mcs-form-field>

        <!-- Summary -->
        <mcs-form-field>
          <input mcsInput #summaryInput required
            mcsId="input-summary"
            [placeholder]="'ticketCreate.placeholders.summary' | translate" maxlength="80"
            [formControl]="fcSummary"
            [mcsContextualHelp]="'ticketCreate.contextualHelp.summary' | translate">

          <mcs-hint mcsHint align="start">
            {{ convertMaxCharText('ticketCreate.hints.summary' | translate, summaryInput.maxLength) }}
          </mcs-hint>
          <mcs-hint mcsHint align="end">
            {{ summaryInput.value.length }} / {{ summaryInput.maxLength }}
          </mcs-hint>
          <mcs-error mcsError errorState="required">
            {{ 'ticketCreate.errors.summaryRequired' | translate }}
          </mcs-error>
        </mcs-form-field>

        <!-- Details -->
        <mcs-form-field>
          <textarea mcsInput rows="3" #detailsInput required
            mcsId="input-details"
            [placeholder]="'ticketCreate.placeholders.details' | translate" maxlength="4000"
            [formControl]="fcDetails"
            [mcsContextualHelp]="'ticketCreate.contextualHelp.details' | translate"></textarea>

          <mcs-hint mcsHint align="start">
            {{ convertMaxCharText('ticketCreate.hints.details' | translate, detailsInput.maxLength) }}
          </mcs-hint>
          <mcs-hint mcsHint align="end">
            {{ detailsInput.value.length }} / {{ detailsInput.maxLength }}
          </mcs-hint>
          <mcs-error mcsError errorState="required">
            {{ 'ticketCreate.errors.detailsRequired' | translate }}
          </mcs-error>
        </mcs-form-field>

        <!-- Services -->
        <mcs-section>
          <h2>{{ 'ticketCreate.services' | translate }}</h2>
          <div>
            <ng-container *ngIf="services">
              <mcs-item>
                <!-- Tags -->
                <mcs-form-field full-width no-margin>
                  <mcs-tag-list [placeholder]="'ticketCreate.placeholders.services' | translate"
                    mcsId="tag-services"
                    [formControl]="fcService">

                    <mcs-tag *ngFor="let subItem of selectService.selectionSubModel.selected"
                      [selectable]="true" [removable]="true"
                      (removed)="selectService.removeSubSelection(subItem)">
                      {{ subItem.text }}
                    </mcs-tag>
                  </mcs-tag-list>

                  <mcs-error mcsError errorState="required">
                    {{ 'ticketCreate.errors.servicesRequired' | translate }}
                  </mcs-error>
                </mcs-form-field>

                <!-- Icon trigger -->
                <div mcsCursor="pointer" margin-left-small
                  (click)="servicePanelOpen = !servicePanelOpen" #trigger
                  mcsId="toggle-service-panel"
                  mcsEventTracker="toggle-service-panel"
                  mcsEventCategory="ticket"
                  mcsEventLabel="create-new-ticket-page">
                  <mcs-icon [key]="toggleIconKey"></mcs-icon>
                  <mcs-ripple class="icon-ripple-wrapper"
                    mcsRipple
                    [rippleTrigger]="trigger"
                    [rippleCentered]="true">
                  </mcs-ripple>
                </div>
              </mcs-item>

              <div [@expansionVertical]="servicePanelOpen ? 'expanded' : 'collapsed'">
                <mcs-select-tag #selectService padding-small
                  (selectionChanged)="serviceItemSelectionChanged($event)">
                  <mcs-select-tag-main-item *ngFor="let service of services"
                    [header]="service.serviceName">

                  <mcs-select-tag-sub-item *ngFor="let item of service.serviceItems"
                    [searchKey]="item.name" [value]="item">
                    {{ item.name }}
                  </mcs-select-tag-sub-item>
                  </mcs-select-tag-main-item>
                </mcs-select-tag>
              </div>
            </ng-container>
          </div>
        </mcs-section>
      </form>

      <!-- Attachments -->
      <mcs-section>
        <h2>{{ 'ticketCreate.attachments' | translate }}</h2>
        <mcs-file-attachment attachedLimit="multiple"
          [allowedMimeType]="['image/jpeg', 'image/png', 'image/bmp', 'text/plain']"
          (attachedFilesChanged)="onChangedAttachments($event)"
          [mcsContextualHelp]="'ticketCreate.contextualHelp.attachments' | translate">
        </mcs-file-attachment>
      </mcs-section>

      <!-- Ticket Action -->
      <div class="action-items">
        <a (click)="gotoTickets()"
          mcsId
          mcsEventTracker="cancel-ticket-creation"
          mcsEventCategory="ticket"
          mcsEventLabel="create-new-ticket-page">{{ 'ticketCreate.cancelActivity' | translate }}</a>

        <button mcsButton  arrow="right" mcsId="new-ticket"
          [disabled]="creatingTicket" (click)="onLogTicket()"
          mcsEventTracker="submit-new-ticket"
          mcsEventCategory="ticket"
          mcsEventLabel="create-new-ticket-page">
          {{ 'ticketCreate.newTicket' | translate }}
        </button>
      </div>
    </div>
  </mcs-content-panel>
</mcs-page>