<mcs-page [header]="getTicketHeader(selectedTicket$ | async)">
  <!-- Top Panel -->
  <mcs-top-panel *mcsTopPanelDef>

    <!-- Back to Tickets -->
    <mcs-top-panel-item *mcsTopPanelItemDef>
      <mcs-action-item mcsAlign="end" mcsId
        mcsRouterLink="Tickets"
        mcsEventTracker="navigate-to-ticket-listing"
        mcsEventCategory="ticket"
        mcsEventLabel="ticket-details-page">
        <mcs-icon [key]="backIconKey" size="small"></mcs-icon>
        <span>{{ 'ticket.backToTickets' | translate }}</span>
      </mcs-action-item>
    </mcs-top-panel-item>
  </mcs-top-panel>

  <!-- Content Panel -->
  <mcs-content-panel *mcsContentPanelDef>
    <div class="limited-view" *ngIf="selectedTicket$ | async as selectedTicket">
      <!-- Ticket description -->
      <mcs-presentation-panel mcsId="ticket-description">
        <ng-container mcsPresentationPanelHeader>
          <h2>{{ 'ticket.description' | translate }}</h2>
        </ng-container>
        <p><strong [innerHTML]="selectedTicket.shortDescription | mcsNewLines"></strong></p>
        <p [innerHTML]="selectedTicket.description | mcsNewLines"></p>
      </mcs-presentation-panel>

      <!-- Ticket details -->
      <mcs-presentation-panel mcsId="ticket-details">
        <ng-container mcsPresentationPanelHeader>
          <h2>{{ 'ticket.information' | translate }}</h2>
        </ng-container>

        <mcs-grid>
          <mcs-grid-row>
            <mcs-grid-column>
              <mcs-item>
                <span>{{ 'ticket.requestor' | translate }}:</span>
                <span [innerHTML]="selectedTicket.requestor | mcsDataLabel"></span>
              </mcs-item>

              <mcs-item>
                <span>{{ 'ticket.createdDate' | translate }}:</span>
                <span>{{ selectedTicket.createdOn | mcsStdDateFormat }}</span>
              </mcs-item>

              <mcs-item>
                <span>{{ 'ticket.customerReference' | translate }}:</span>
                <span [innerHTML]="selectedTicket.customerReference | mcsDataLabel: 'None'"></span>
              </mcs-item>
            </mcs-grid-column>

            <mcs-grid-column>
              <mcs-item>
                <span>{{ 'ticket.status' | translate }}:</span>
                <mcs-icon *ngIf="selectedTicket.resolved" [key]="checkIconKey" size="small"></mcs-icon>
                <span [innerHTML]="selectedTicket.stateLabel | mcsDataLabel"></span>
                <span *ngIf="selectedTicket.resolved">
                  ({{ selectedTicket.createdOn | mcsStdDateFormat }})
                </span>
              </mcs-item>

              <mcs-item>
                <span>{{ 'ticket.type' | translate }}:</span>
                <span>{{ getSubTypeString(selectedTicket.subType) }}</span>
              </mcs-item>
            </mcs-grid-column>
          </mcs-grid-row>
        </mcs-grid>
      </mcs-presentation-panel>

      <!-- Ticket closure details -->
      <mcs-presentation-panel *ngIf="selectedTicket.closed" mcsId="ticket-closure-details">
        <ng-container mcsPresentationPanelHeader>
          <h2>{{ 'ticket.closureDetails' | translate }}</h2>
        </ng-container>

        <mcs-grid>
          <mcs-grid-row>
            <mcs-grid-column>
              <mcs-item>
                <span>{{ 'ticket.closureDate' | translate }}:</span>
                <span [innerHTML]="(selectedTicket.closureInformation?.closedAt |
                  mcsStdDateFormat) | mcsDataLabel"></span>
              </mcs-item>

              <mcs-item>
                <span>{{ 'ticket.closureNotes' | translate }}:</span>
                <span [innerHTML]="selectedTicket.closureInformation?.closeNotes |
                  mcsDataLabel: 'None'"></span>
              </mcs-item>
            </mcs-grid-column>

            <mcs-grid-column>
              <mcs-item>
                <span>{{ 'ticket.rootCause' | translate }}:</span>
                <span [innerHTML]="selectedTicket.closureInformation?.closeProblem |
                  mcsDataLabel: 'None'"></span>
              </mcs-item>

              <mcs-item>
                <span>{{ 'ticket.resolution' | translate }}:</span>
                <span [innerHTML]="selectedTicket.closureInformation?.closeResolution |
                  mcsDataLabel: 'None'"></span>
              </mcs-item>
            </mcs-grid-column>
          </mcs-grid-row>
        </mcs-grid>
      </mcs-presentation-panel>

      <!-- Ticket Services and Attachments -->
      <mcs-grid>
        <mcs-grid-row>
          <mcs-grid-column sizeSm="12" mcsId="ticket-services">
            <mcs-presentation-panel>
              <ng-container mcsPresentationPanelHeader>
                <h2>{{ 'ticket.services' | translate }}</h2>
              </ng-container>

              <ng-container *ngIf="selectedTicket.serviceId | mcsIsNotNullOrEmpty; else noServices">
                <mcs-list spacing="auto">
                  <mcs-list-item *ngFor="let service of selectedTicket.serviceId">
                    <span>{{ service }}</span>
                  </mcs-list-item>
                </mcs-list>
              </ng-container>

              <ng-template #noServices>
                <mcs-data-status-empty>
                  {{ 'ticket.missingServicesLabel' | translate }}
                </mcs-data-status-empty>
              </ng-template>
            </mcs-presentation-panel>
          </mcs-grid-column>

          <mcs-grid-column sizeSm="12" mcsId="ticket-attachments">
            <mcs-presentation-panel>
              <ng-container mcsPresentationPanelHeader>
                <h2>{{ 'ticket.attachments' | translate }}</h2>
              </ng-container>

              <ng-container *ngIf="selectedTicket.attachments | mcsIsNotNullOrEmpty; else noAttachments">
                <mcs-list spacing="small">
                  <mcs-list-item *ngFor="let attachment of selectedTicket.attachments">
                    <mcs-file-download [fileType]="attachment.contentType"
                      [downloading]="isDownloading(attachment?.id)"
                      (download)="downloadAttachment(selectedTicket, attachment)"
                      mcsId="download-attachment"
                      mcsEventTracker="download-attachment"
                      mcsEventCategory="ticket"
                      mcsEventLabel="ticket-details-page">
                      {{ attachment.fileName }}
                    </mcs-file-download>
                  </mcs-list-item>
                </mcs-list>
              </ng-container>

              <ng-template #noAttachments>
                <mcs-data-status-empty>
                  {{ 'ticket.missingAttachmentsLabel' | translate }}
                </mcs-data-status-empty>
              </ng-template>
            </mcs-presentation-panel>
          </mcs-grid-column>
        </mcs-grid-row>

        <mcs-grid-row>
          <mcs-grid-column>
            <!-- Ticket Activities -->
            <mcs-presentation-panel mcsId="ticket-activities">
              <ng-container mcsPresentationPanelHeader>
                <h2>{{ 'ticket.activity' | translate }}</h2>
              </ng-container>

              <ng-container *mcsAccessControl="['TicketCommentCreate']">
                <div *mcsExclusiveForAccount="'default'">
                  <mcs-comment-box attachedLimit="single" [disabled]="creatingComment$ | async"
                    [allowedMimeType]="['image/jpeg', 'image/png', 'image/bmp', 'text/plain']"
                    (onAddComment)="createComment(selectedTicket, $event)">
                  </mcs-comment-box>
                </div>
              </ng-container>

              <ng-container *ngIf="ticketActivites$ | async as ticketActivities">
                <mcs-section *ngIf="ticketActivities | mcsIsNotNullOrEmpty; else noActivities">
                  <mcs-ticket-activity *ngFor="let activity of ticketActivities"
                    [ticketId]="selectedTicket.id"
                    [activity]="activity">
                  </mcs-ticket-activity>
                </mcs-section>
                <ng-template #noActivities>
                  <mcs-data-status-empty>
                    {{ 'ticket.missingActivitiesLabel' | translate }}
                  </mcs-data-status-empty>
                </ng-template>
              </ng-container>
            </mcs-presentation-panel>
          </mcs-grid-column>
        </mcs-grid-row>
      </mcs-grid>
    </div>
  </mcs-content-panel>
</mcs-page>