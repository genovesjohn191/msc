<mcs-page [header]="ticketHeader">
  <!-- Top Panel -->
  <mcs-top-panel *mcsTopPanelDef>

    <!-- Ticket Status -->
    <ng-container *ngIf="ticketResolved">
      <mcs-top-panel-item *mcsTopPanelItemDef>
        <div flex="auto" display-flex align-items="center" justify-content="flex-end">
          <mcs-icon [key]="checkIconKey" size="large"></mcs-icon>
          <span>
            {{ getStateString(ticket.state) }} ({{ convertDateToString(ticket.createdOn) }})
          </span>
        </div>
      </mcs-top-panel-item>
    </ng-container>

    <!-- Back to Tickets -->
    <mcs-top-panel-item *mcsTopPanelItemDef>
      <mcs-action-item class="right-align" (click)="gotoTickets()"
        mcsEventTracker="navigate-to-ticket-listing"
        mcsEventCategory="ticket"
        mcsEventLabel="ticket-details-page">
        <mcs-icon [key]="backIconKey" size="large"></mcs-icon>
        <span>{{ textContent.backToTickets }}</span>
      </mcs-action-item>
    </mcs-top-panel-item>
  </mcs-top-panel>

  <!-- Content Panel -->
  <mcs-content-panel *mcsContentPanelDef>

    <!-- Loader settings -->
    <div [mcsLoader]="ticketSubscription"
      [mcsLoaderHideElement]="ticketDetailsContent"
      [mcsLoaderText]="textContent.loading"
      mcsLoaderOrientation="top"></div>

    <div class="limited-view" #ticketDetailsContent>

      <!-- Ticket details -->
      <div class="container-wrapper">
        <h4 class="container-header" [innerHTML]="ticket.shortDescription | mcsNewLines"></h4>
        <div class="grid-row vspace-medium">
          <div class="grid-column">
            <div class="inline-items-xsmall">
              <mcs-icon size="small" [key]="userIconKey"></mcs-icon>
              <strong>{{ requestor }}</strong>
            </div>
            <span read-only>{{ convertDateToString(ticket.createdOn) }}</span>
          </div>

          <div class="grid-column">
            <strong>{{ textContent.status }}</strong><br/>
            <span read-only>{{ getStateString(ticket.state) }}</span>
          </div>

          <div class="grid-column">
            <strong>{{ textContent.type }}</strong><br/>
            <span read-only>{{ getSubTypeString(ticket.subType) }}</span>
          </div>
        </div>
        <div>
          <div class="divider"></div>
          <p [innerHTML]="ticket.description | mcsNewLines"></p>
        </div>
      </div>

      <!-- Ticket Services and Attachments -->
      <div class="grid-row">
        <div class="container-wrapper grid-column break-on-small">
          <h4 class="container-header">{{ textContent.services }}</h4>
          <p *ngIf="missingServices" read-only>
            {{ textContent.missingServicesLabel }}
          </p>
          <ul class="inline-list">
            <li *ngFor="let service of ticket.serviceId; trackBy: trackByFn">
              {{ service }}
            </li>
          </ul>
        </div>

        <div class="container-wrapper grid-column break-on-small">
          <h4 class="container-header">{{ textContent.attachments }}</h4>
          <p *ngIf="missingAttachments" read-only>
            {{ textContent.missingAttachmentsLabel }}
          </p>
          <ul class="inline-list rollover">
            <li *ngFor="let attachment of ticket.attachments; trackBy: trackByFn">
              <mcs-icon [key]="attachmentIconKey" size="small"></mcs-icon>
              <a (click)="downloadAttachment(attachment)"
                mcsEventTracker="download-attachment"
                mcsEventCategory="ticket"
                mcsEventLabel="ticket-details-page">{{ attachment.fileName }}</a>
            </li>
          </ul>
        </div>
      </div>

      <!-- Ticket Activities -->
      <div class="container-wrapper">
        <h4 class="container-header">{{ textContent.activity }}</h4>
        <p *ngIf="missingActivities" read-only>
          {{ textContent.missingActivitiesLabel }}
        </p>
      </div>
      <div class="block-items-medium">
        <ng-container *mcsAccessControl="['TicketEdit']">
          <div *mcsExclusiveForAccount="'default'" class="position-relative">
            <div [mcsLoader]="[createCommentSubscription, createAttachmentSubscription]"
              [mcsLoaderHideElement]="commentBox"
              [mcsLoaderPreserveHeight]="true"
              [mcsLoaderText]="textContent.creatingComment">
            </div>
            <div #commentBox>
              <mcs-comment-box attachedLimit="single"
                [allowedMimeType]="['image/jpeg', 'image/png', 'image/bmp', 'text/plain']"
                (onAddComment)="createComment($event)">
              </mcs-comment-box>
            </div>
          </div>
        </ng-container>
        <div>
          <mcs-ticket-activity [ticketId]="ticket.id"
            class="vspace-xsmall"
            *ngFor="let activity of activities; trackBy: trackByFn"
            [activity]="activity">
          </mcs-ticket-activity>
        </div>
      </div>
    </div>
  </mcs-content-panel>
</mcs-page>