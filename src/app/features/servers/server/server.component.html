<mcs-page>
  <!-- Page template header -->
  <ng-container *mcsPageHeader>
    <mcs-item *ngIf="selectedServer$ | async as selectedServer">
      <div>
        <a [mcsRouterLink]="[routeKeyEnum.VdcDetail, selectedServer.platform?.resourceId]"
          mcsId="select-vdc"
          mcsEventTracker="select-vdc"
          mcsEventCategory="vdc"
          mcsEventLabel="server-details-page">
          <h1>{{ selectedServer.resourceName }}</h1>
        </a>
      </div>
      <mcs-icon [key]="angleDoubleRightIconKey" size="xsmall"></mcs-icon>
      <div>
        <h1>{{ selectedServer.name }}</h1>
      </div>
    </mcs-item>
  </ng-container>

  <!-- Left Panel -->
  <mcs-left-panel *mcsLeftPanelDef="textContent.leftPanelHeader">
    <!-- listing panel -->
    <mcs-left-panel-item *mcsLeftPanelItemDef>
      <div class="listing-panel-wrapper">
        <mcs-search #search mcsId="virtual-listing-panel-search"></mcs-search>

        <mcs-data-status [dataStatusFactory]="listStatusFactory">
          <mcs-data-status-success mcsDataSuccess>

            <mcs-list-panel>
              <ng-container *ngFor="let iterator of ((serversMap$ | async) | mcsMapIterable) |
                mcsSortArray: serverListSource?.sortResourceMethod">

                <mcs-option-group>
                  <ng-container *mcsOptionGroupLabel>
                    <ng-container *ngIf="iterator.key?.resourceId">
                      <a [mcsRouterLink]="[routeKeyEnum.VdcDetail, iterator.key?.resourceId]"
                        mcsId="select-vdc"
                        mcsEventTracker="select-vdc"
                        mcsEventCategory="vdc"
                        mcsEventLabel="server-list-panel">
                        {{ iterator.key?.resourceName }}
                      </a>
                    </ng-container>
                    <ng-container *ngIf="!iterator.key?.resourceId">
                      <span>{{ iterator.key?.resourceName }}</span>
                    </ng-container>
                  </ng-container>

                  <ng-container *ngFor="let server of (iterator.value | mcsSortArray: serverListSource?.serversSortMethod)">
                    <a [mcsRouterLink]="[routeKeyEnum.ServerDetail, server.id]"
                      [disabled]="server.isDeleting"
                      mcsId="select-server"
                      mcsEventTracker="select-server"
                      mcsEventCategory="server"
                      mcsEventLabel="server-list-panel">

                      <mcs-option [value]="server"
                        [selected]="(selectedServer$ | async)?.id === server.id">
                        <mcs-item>
                          <mcs-icon *ngIf="!server.isProcessing" size="small"
                            [key]="server?.powerStateIconKey"></mcs-icon>

                          <mcs-loader *ngIf="server.isProcessing" size="small"
                            [mcsTooltip]="server.processingText"
                            mcsTooltipPosition="right"></mcs-loader>

                          <span text-wrap>{{ server.name }}</span>
                        </mcs-item>
                      </mcs-option>
                    </a>
                  </ng-container>
                </mcs-option-group>
              </ng-container>
            </mcs-list-panel>
          </mcs-data-status-success>

          <mcs-data-status-in-progress mcsDataInProgress>
            <span>{{ serversTextContent.loading }}</span>
          </mcs-data-status-in-progress>

          <mcs-data-status-empty mcsDataEmpty>
            <span>{{ serversTextContent.noServers }}</span>
          </mcs-data-status-empty>

          <mcs-data-status-error mcsDataError>
            <span>{{ serversTextContent.errorMessage }}</span>
          </mcs-data-status-error>
        </mcs-data-status>
      </div>
    </mcs-left-panel-item>
  </mcs-left-panel>

  <mcs-content-panel *mcsContentPanelDef>
    <div class="routing-tab-wrapper" *ngIf="selectedServer$ | async as selectedServer">
      <!-- Busy status of the server -->
      <ng-container *ngIf="selectedServer.isProcessing">
        <mcs-busy-ribbon theme="dark" margin-bottom-small>
          <span>{{ textContent.serverBusyLabel }}</span>
        </mcs-busy-ribbon>
      </ng-container>

      <mcs-tab-group [selectedTabId]="selectedRoutingTab" (tabChanged)="onTabChanged($event)">
        <!-- Management Tab -->
        <mcs-tab [label]="textContent.management.label" id="management"></mcs-tab>

        <!-- Services Tab -->
        <ng-container *ngIf="selectedServer.isManagedVCloud">
          <mcs-tab [label]="textContent.services.label" id="services" *mcsAccessControl="[]; feature: 'EnableServerOsUpdates'"></mcs-tab>
        </ng-container>

        <!-- Storage Tab -->
        <mcs-tab [label]="textContent.storage.label" id="storage"
          *mcsAccessControl="[]; feature: 'EnableDedicatedVmStorageView';
          validateWhen: selectedServer.isDedicated"></mcs-tab>

        <!-- Snapshots Tab -->
        <mcs-tab label="Snapshots" id="snapshots"
          *mcsAccessControl="[]; feature: 'EnableDedicatedVmSnapshotView';
          validateWhen: selectedServer.isDedicated"></mcs-tab>

        <!-- Networks Tab -->
        <mcs-tab [label]="textContent.nics.label" id="nics"
          *mcsAccessControl="[]; feature: 'EnableDedicatedVmNicView';
          validateWhen: selectedServer.isDedicated"></mcs-tab>

        <!-- Action tab -->
        <mcs-tab [canSelect]="false" align="end"
          *mcsAccessControl="['VmPowerStateEdit']">
          <ng-template mcsTabLabel>
            <mcs-server-command mcsId="server-command"
              [server]="selectedServer"
              (onClick)="executeServerCommand(selectedServer, $event)">
            </mcs-server-command>
          </ng-template>
        </mcs-tab>
      </mcs-tab-group>

      <!-- Tab content for routing tab -->
      <div class="routing-tab-content-wrapper limited-view">
        <router-outlet></router-outlet>
      </div>
    </div>
  </mcs-content-panel>
</mcs-page>