<ng-container *ngIf="server$ | async as server">
  <ng-container [ngSwitch]="serviceView$ | async">

    <!-- Default View -->
    <section [@fadeIn] *ngSwitchCase="serverServicesViewOption.Default">
      <!-- Operating System Updates -->
      <mcs-presentation-panel *mcsAccessControl="serverPermission.vmPatchManagement; feature: 'EnableServerOsUpdates'">
        <ng-container mcsPresentationPanelHeader>
          <h2>{{ 'serverServices.operatingSystemUpdates.title' | translate }}</h2>
        </ng-container>
        <p>{{ 'serverServices.operatingSystemUpdates.description' | translate }}</p>

        <mcs-section>
          <mcs-form-message #formMessage></mcs-form-message>
          <mcs-grid *ngIf="server.osAutomationAvailable; else osAutomationNotAvailable">
            <mcs-data-status [dataStatusFactory]="dataStatusFactory">
              <mcs-data-status-success mcsDataSuccess>

                <!-- Status -->
                <mcs-grid-row *ngIf="updatesDetails$ | async as updatesDetails">
                  <mcs-grid-column sizeLg="9">
                    <mcs-item orientation="block">
                      <strong>{{ 'serverServices.operatingSystemUpdates.updatesStatusTitleLabel' | translate }}</strong>
                      <mcs-item>
                        <mcs-icon [key]="updateStatusConfiguration.updatesStatusIcon" size="small"></mcs-icon>
                        <div>
                          <span mcsId="status-label">{{ updateStatusConfiguration.updatesStatusLabel }}</span><br />
                          <small read-only *ngIf="updateStatusConfiguration.updateStatusHasNoErrors">
                            <mcs-item orientation="inline">
                              <ng-container [ngSwitch]="updateStatusConfiguration.status">
                                <span mcsId="status-sublabel-updating"
                                  [@fadeIn] *ngSwitchCase="osUpdateStatusOption.Updating">
                                  {{ updatesStatusSubtitleLabelUpdating }}
                                </span>
                                <span mcsId="status-sublabel-default"
                                  [@fadeIn] *ngSwitchDefault>
                                  {{ updatesStatusSubtitleLabelDefault }}
                                </span>
                              </ng-container>
                              <ng-container *ngIf="updateStatusConfiguration.inspectButtonShown">
                                <a mcsId="inspect-server-link"
                                  mcsEventTracker="os-updates-inspect-server-click"
                                  mcsEventCategory="server"
                                  mcsEventLabel="os-updates-inspect-server"
                                  (click)="inspectForAvailableOsUpdates(server)"
                                  *mcsAccessControl="serverPermision.vmPatchManagement"
                                  [disabled]="inspectNowButtonDisabled(server)">
                                  {{ 'serverServices.operatingSystemUpdates.updatesAnalysisLabel' | translate }}
                                </a>
                              </ng-container>
                            </mcs-item>
                          </small>
                        </div>
                      </mcs-item>
                    </mcs-item>
                  </mcs-grid-column>

                  <mcs-grid-column mcsAlignContent="middle-right">
                    <ng-container *ngIf="updateStatusConfiguration.runNowButtonShown">
                      <button mcsButton size="xsmall"
                        *mcsAccessControl="serverPermision.vmPatchManagement"
                        mcsId="update-now-button"
                        mcsEventTracker="os-updates-update-now-click"
                        mcsEventCategory="server"
                        mcsEventLabel="os-updates-update-now"
                        (click)="setViewMode(serverServicesViewOption.OsUpdateApplyNow)"
                        [disabled]="server.isProcessing">
                        {{ 'serverServices.operatingSystemUpdates.updatesScheduleRunNowLink' | translate }}
                      </button>
                    </ng-container>
                  </mcs-grid-column>
                </mcs-grid-row>

                <!-- Schedule/Jobs -->
                <mcs-grid-row *ngIf="updatesDetails$ | async as updatesDetails">
                  <mcs-grid-column>
                    <mcs-item orientation="block">
                      <strong>{{ 'serverServices.operatingSystemUpdates.updatesScheduleTitleLabel' | translate }}</strong>
                      <mcs-item>
                        <mcs-icon [key]="clockKey" size="small"></mcs-icon>
                        <div>
                          <span>{{ updatesScheduleLabel }}</span><br />
                          <small read-only *ngIf="updateStatusConfiguration.updateStatusHasNoErrors">
                            <mcs-item orientation="inline">
                              <span *ngIf="updateStatusConfiguration.hasSchedule"
                                mcsId="schedule-sublabel">
                                {{ updateStatusConfiguration.updatesScheduleSubtitleLabel }}
                              </span>
                              <span [mcsTooltip]="updateStatusConfiguration.updatesScheduleConfigureHoverLabel"
                                [mcsTooltipShow]="updateStatusConfiguration.configureScheduleButtonDisabled">
                                <ng-container *ngIf="updateStatusConfiguration.updateStatusHasNoErrors">
                                  <a
                                    mcsId="configure-schedule-link"
                                    mcsEventTracker="os-updates-configure-schedule-click"
                                    mcsEventCategory="server"
                                    mcsEventLabel="os-updates-configure-schedule"
                                    *mcsAccessControl="serverPermision.vmPatchManagement"
                                    (click)="setViewMode(serverServicesViewOption.OsUpdateSchedule)"
                                    [disabled]="configureButtonDisabled(server)">
                                    {{ 'serverServices.operatingSystemUpdates.updatesScheduleConfigureLink' | translate }}
                                  </a>
                                </ng-container>
                              </span>
                            </mcs-item>
                          </small>
                        </div>
                      </mcs-item>
                    </mcs-item>

                    <mcs-item *ngIf="updateStatusConfiguration.updatesScheduleRunOnceWarningLabelShown">
                      <mcs-data-status-warning margin-left-large>
                        <small>
                          {{ 'serverServices.operatingSystemUpdates.updatesScheduleRunOnceWarningLabel' | translate }}
                        </small>
                      </mcs-data-status-warning>
                    </mcs-item>

                  </mcs-grid-column>
                </mcs-grid-row>
              </mcs-data-status-success>

              <mcs-data-status-in-progress mcsDataInProgress>
                <span>{{ 'serverServices.operatingSystemUpdates.loadingContent' | translate }}</span>
              </mcs-data-status-in-progress>

              <mcs-data-status-error mcsDataError>
                <span>{{ 'serverServices.operatingSystemUpdates.errorGettingServerDetails' | translate }}</span>
              </mcs-data-status-error>
            </mcs-data-status>
          </mcs-grid>
        </mcs-section>
        <ng-template #osAutomationNotAvailable>
            <mcs-status-message type="info">
                {{ 'serverServices.operatingSystemUpdates.osAutomationNotAvailable' | translate }}
            </mcs-status-message>
        </ng-template>
      </mcs-presentation-panel>

      <!-- InView -->
      <mcs-presentation-panel *mcsAccessControl="[]; feature: 'EnableOrderingManagedServerInviewLevelRaise'">
        <ng-container mcsPresentationPanelHeader>
          <h2>{{ 'serverServices.inview.title' | translate }}</h2>
        </ng-container>
        <p>{{ 'serverServices.inview.description' | translate }}</p>

        <mcs-section>
          <mcs-grid-row>
            <mcs-grid-column>
              <mcs-item orientation="block">
                <strong>{{ 'serverServices.inview.inviewLevelLabel' | translate }}</strong>
                <p mcsId="raise-inview-level-description">{{inviewLevelDescription(server)}}</p>
              </mcs-item>
            </mcs-grid-column>
          </mcs-grid-row>
          <ng-container *ngIf="raiseInviewButtonsShown(server) || goToInviewButtonsShown(server)">
            <mcs-grid-row *mcsExclusiveForAccount>
              <mcs-item>
                <ng-container *ngIf="goToInviewButtonsShown(server)">
                  <a mcsButton size="xsmall"
                    mcsId="goto-inview-level"
                    mcsEventTracker="goto-inview-level-click"
                    mcsEventCategory="server"
                    mcsEventLabel="goto-inview-level-button"
                    [href]="inviewUrl(server)"
                    target="_blank"
                    [disabled]="server.isProcessing">
                    {{ 'serverServices.inview.goToinviewButtonLabel' | translate }}
                  </a>
                </ng-container>
                <ng-container *mcsAccessControl="['OrderEdit']">
                  <ng-container *ngIf="raiseInviewButtonsShown(server)">
                    <button mcsButton size="xsmall"
                      mcsId="raise-inview-level"
                      mcsEventTracker="raise-inview-level-click"
                      mcsEventCategory="server"
                      mcsEventLabel="raise-inview-level-button"
                      (click)="raiseInviewLevel(server)"
                      [disabled]="server.isProcessing && server.serviceChangeAvailable">
                      {{ 'serverServices.inview.raiseinviewButtonLabel' | translate }}
                    </button>
                  </ng-container>
                </ng-container>
              </mcs-item>
            </mcs-grid-row>
          </ng-container>
        </mcs-section>
      </mcs-presentation-panel>

       <!-- Host Security -->
       <ng-container *mcsAccessControl="[]; feature: ['EnableAddonHidsView','EnableAddonAntiVirusView']">
         <ng-container *ngIf="serverHostSecurityDetails$ | async as serverHostSecurityDetails">
          <mcs-presentation-panel *ngIf="serverHostSecurityDetails?.hids?.provisioned || serverHostSecurityDetails?.antiVirus?.provisioned">
            <ng-container mcsPresentationPanelHeader>
              <h2>{{ 'serverServices.hostSecurity.title' | translate }}</h2>
            </ng-container>
            <mcs-section>
              <mcs-presentation-panel>
                <ng-container mcsPresentationPanelHeader>
                  <mcs-item>
                    <mcs-icon [key]="serverHostSecurityDetails.icon" size="small" mcsId="hids-status-icon"></mcs-icon>
                    <h2>{{ serverHostSecurityDetails.message }}</h2>
                  </mcs-item>
                </ng-container>
                <mcs-section>

                  <!-- Hids -->
                  <ng-container orientation="block" *mcsAccessControl="[]; feature: 'EnableAddonHidsView'">
                    <mcs-item *ngIf="serverHostSecurityDetails?.hids?.provisioned">
                      <mcs-service-hids
                        [hids]="serverHostSecurityDetails?.hids"
                        (viewChange)="onViewChange($event)">
                      </mcs-service-hids>
                    </mcs-item>
                  </ng-container>

                  <!-- Anti Virus -->
                  <ng-container orientation="block" *mcsAccessControl="[]; feature: 'EnableAddonAntiVirusView'">
                    <mcs-item *ngIf="serverHostSecurityDetails?.antiVirus?.provisioned">
                      <mcs-service-anti-virus
                        [antivirus]="serverHostSecurityDetails?.antiVirus"
                        (viewChange)="onViewChange($event)">
                      </mcs-service-anti-virus>
                    </mcs-item>
                  </ng-container>
                </mcs-section>
              </mcs-presentation-panel>
            </mcs-section>
          </mcs-presentation-panel>
        </ng-container>
      </ng-container>

      <!-- VM Backup -->
      <ng-container *mcsAccessControl="[]; feature: 'EnableAddonVmBackupView'">
        <ng-container *ngIf="serverBackUpVm$ | async as vmBackup">
          <ng-container *ngIf="vmBackup.provisioned">
            <mcs-service-backup-vm
              [serverBackupVm]="vmBackup"
              (viewChange)="onViewChange($event)">
            </mcs-service-backup-vm>
          </ng-container>
        </ng-container>
      </ng-container>

      <!-- Server Backup -->
      <ng-container *mcsAccessControl="[]; feature: 'EnableAddonServerBackupView'">
        <ng-container *ngIf="serverBackUpServer$ | async as serverBackup">
          <ng-container *ngIf="serverBackup.provisioned">
            <mcs-service-backup-server
              [serverBackupServer]="serverBackup"
              (viewChange)="onViewChange($event)">
            </mcs-service-backup-server>
          </ng-container>
        </ng-container>
      </ng-container>
    </section>

    <!-- TODO: Align the switch to easily view the cases -->
    <!-- Os Updates Schedule View -->
    <ng-container *mcsAccessControl="serverPermission.vmPatchManagement; feature: 'EnableServerOsUpdates'">
      <ng-container *ngIf="updatesDetails$ | async">
        <!-- Unscheduled / Run Now / Update Now -->
        <ng-container [@fadeIn] *ngSwitchCase="serverServicesViewOption.OsUpdateApplyNow">
          <mcs-server-os-updates-apply-now [selectedServer]="server" (applyUpdates)="onApplyUpdates($event)">
            <ng-container mcsViewServicesTab *ngTemplateOutlet="servicesTabView"></ng-container>
          </mcs-server-os-updates-apply-now>
        </ng-container>

        <!-- Scheduled Type Later/RunOnce or Recurring -->
        <ng-container [@fadeIn] *ngSwitchCase="serverServicesViewOption.OsUpdateSchedule">
          <mcs-server-os-updates-schedule [selectedServer]="server" (saveSchedule)="onSaveSchedule($event)"
            (deleteSchedule)="onDeleteSchedule($event)">
            <ng-container mcsViewServicesTab *ngTemplateOutlet="servicesTabView"></ng-container>
          </mcs-server-os-updates-schedule>
        </ng-container>
      </ng-container>
    </ng-container>

  </ng-container>

  <!-- Go back to services tab view -->
  <ng-template #servicesTabView>
    <a mcsButton="basic" size="medium"
      mcsId="back-to-services-link"
      mcsEventTracker="os-updates-back-to-services-click"
      mcsEventCategory="server"
      mcsEventLabel="os-updates-back-to-services"
      (click)="setViewMode(serverServicesViewOption.Default)"
      [disabled]="server.isProcessing">
      <mcs-item>
        <mcs-icon [key]="chevronLeftKey" size="xsmall"></mcs-icon>
        <span>{{ 'serverServices.operatingSystemUpdates.label' | translate }}</span>
      </mcs-item>
    </a>
  </ng-template>
</ng-container>
